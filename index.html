<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Side Industry 2.1 — MiniApp</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
      :root {
  --bg: #161c25;
  --header-bg: linear-gradient(90deg, #22283a 50%, #472f85 100%);
  --card-bg: #232a3c;
  --primary: #FFD600;
  --accent: #7c5ee6;
  --text: #fafafa;
  --muted: #9aa2bc;
  --green: #4eea89;
  --danger: #e25454;
}

/* ----- Base ----- */
html, body {
  margin: 0;
  padding: 0;
  background: var(--bg);
  color: var(--text);
  font-family: 'Roboto', Arial, sans-serif;
  min-height: 100vh;
  -webkit-tap-highlight-color: transparent;
  overscroll-behavior: none;
}
* { box-sizing: border-box; }

/* ----- Overlay d'accès ----- */
#accessOverlay {
  position: fixed;
  top: 0; left: 0; width: 100vw; height: 100vh;
  background: #181f2fdc;
  z-index: 9999;
  display: flex; align-items: center; justify-content: center;
}
#accessOverlay .access-box {
  background: var(--card-bg);
  padding: 34px 18px 24px 18px;
  border-radius: 17px;
  box-shadow: 0 7px 36px #000b;
  text-align: center;
  min-width: 240px; max-width: 96vw;
  width: 98vw;
}
#accessOverlay .access-title {
  color: var(--primary);
  font-size: 1.19rem;
  font-weight: bold;
  margin-bottom: 14px;
  letter-spacing: 0.05em;
}
#accessOverlay .access-input {
  width: 94%;
  padding: 13px 11px;
  margin-top: 14px;
  font-size: 1.12rem;
  border-radius: 8px;
  border: 1.5px solid #323e5a;
  background: #1b2130;
  color: var(--text);
}
#accessOverlay .access-btn {
  margin-top: 19px;
  background: var(--accent);
  color: var(--primary);
  font-weight: 700;
  border: none;
  border-radius: 9px;
  padding: 12px 24px;
  font-size: 1.08rem;
  cursor: pointer;
  width: 94%;
}
#accessOverlay .access-btn:active {
  background: var(--primary); color: #181f2d;
}
#accessOverlay .access-error {
  margin-top: 9px; color: var(--danger); font-size: 1rem;
}

/* ----- Header ----- */
.tg-header {
  display: flex; align-items: center;
  background: var(--header-bg);
  padding: 14px 0 10px 0;
  justify-content: center;
  box-shadow: 0 1.5px 9px #0008;
  position: sticky; top: 0; z-index: 50;
}
.tg-logo {
  width: 32px; height: 32px;
  border-radius: 10px; object-fit: cover;
  margin-right: 12px;
}
.tg-title {
  font-family: 'Montserrat', Arial, sans-serif;
  font-weight: 900;
  font-size: 1.19rem;
  color: var(--primary);
  letter-spacing: 1.1px;
  margin-right: 7px;
}
.tg-miniapp {
  background: #111b2580;
  color: var(--primary);
  font-size: 0.89rem;
  font-weight: 700;
  border-radius: 8px;
  padding: 2px 11px 3px 11px;
  font-family: 'Montserrat', Arial, sans-serif;
}

/* ----- Menu top (config) ----- */
.menu-top {
  max-width: 480px;
  margin: 17px auto 12px auto;
  padding: 0 6vw;
  display: flex;
  justify-content: flex-end;
  gap: 9px;
}
.menu-btn {
  background: #22283a;
  color: var(--primary);
  border: none;
  border-radius: 13px;
  padding: 8px 16px;
  font-size: 1rem;
  font-family: 'Montserrat', Arial, sans-serif;
  font-weight: 700;
  cursor: pointer;
  transition: background 0.18s;
}
.menu-btn:active { background: var(--accent); color: var(--text); }

/* ----- Welcome ----- */
.welcome {
  margin: 12px auto 13px auto;
  padding: 0 4vw;
  max-width: 390px;
  font-size: 1.02rem;
  color: var(--muted);
  text-align: center;
}

/* ----- Section Title ----- */
.section-title {
  color: var(--primary);
  text-align: center;
  font-size: 1.14rem;
  letter-spacing: 0.13em;
  margin: 7px 0 11px 0;
  font-family: 'Montserrat', Arial, sans-serif;
  font-weight: 700;
}

/* ----- Filtres ----- */
.filters {
  display: flex; justify-content: center; gap: 8px; margin: 0 0 14px 0; flex-wrap: wrap;
}
.filter-btn {
  background: #232a3c;
  color: var(--muted);
  border: none;
  border-radius: 11px;
  padding: 8px 14px;
  font-size: 1.02rem;
  cursor: pointer;
  font-weight: 600;
  outline: none;
  transition: background 0.2s, color 0.2s;
  margin-bottom: 6px;
}
.filter-btn.active, .filter-btn:active {
  background: var(--accent);
  color: var(--primary);
}

/* ----- Grid Produits ----- */
.products-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 17px;
  max-width: 500px;
  margin: 0 auto 56px auto;
  padding: 0 4vw;
}
@media (min-width:600px) {
  .products-grid {
    grid-template-columns: repeat(auto-fit, minmax(270px, 1fr));
    gap: 20px;
    max-width: 870px;
  }
}

/* ----- Carte Produit ----- */
.product-card {
  background: var(--card-bg);
  border-radius: 18px;
  box-shadow: 0 4px 18px #000b;
  padding: 0 0 15px 0;
  display: flex; flex-direction: column;
  min-height: 298px;
  position: relative;
  overflow: hidden;
  margin-bottom: 0px;
  transition: box-shadow 0.16s;
}
.product-card:active {
  box-shadow: 0 2px 9px #0004;
  outline: 1.5px solid var(--accent);
}
.card-img {
  width: 100%;
  height: 135px;
  object-fit: cover;
  border-radius: 18px 18px 0 0;
  margin-bottom: 0px;
  background: #181f2d;
}
.product-type {
  position: absolute; top: 11px; left: 11px;
  background: #222d43ee;
  color: var(--muted);
  font-size: 0.89rem;
  border-radius: 8px;
  padding: 2px 11px;
  font-weight: 700;
  z-index: 2;
}
.product-name {
  margin: 10px 0 0px 0;
  font-family: 'Montserrat', Arial, sans-serif;
  font-weight: 900;
  color: var(--primary);
  font-size: 1.09rem;
  letter-spacing: 0.01em;
}
.product-price {
  color: var(--muted);
  font-size: 1.01rem;
  margin-bottom: 5px;
  font-weight: 700;
}
.product-promo {
  color: var(--green);
  font-size: 1.02rem;
  font-weight: bold;
  margin: 3px 0 2px 0;
}

/* ----- Boutons ----- */
.order-btn {
  background: linear-gradient(90deg,#8a63fa,#7043d4 90%);
  color: #ffd700;
  border: none;
  font-size: 1.15rem;
  font-weight: bold;
  border-radius: 14px;
  padding: 16px 0;
  cursor: pointer;
  margin: 30px auto 4px auto;
  width: 96%;
  box-shadow: 0 2px 12px #0003;
  letter-spacing: 0.2px;
  transition: background .18s,box-shadow .18s;
}
.order-btn:hover {
  background: linear-gradient(90deg,#6a43d4,#8a63fa 90%);
  box-shadow: 0 3px 18px #8857ee99;
}
.order-btn:active { background: var(--primary); color: #181f2d; }
.details-btn {
  margin-top: 8px;
  background: var(--card-bg);
  color: var(--primary);
  border: 2px solid var(--primary);
  font-weight: 700;
  border-radius: 11px;
  padding: 8px 0;
  cursor: pointer;
  font-size: 1.03rem;
  width: 93%;
  align-self: center;
  transition: background 0.18s, color 0.17s, border 0.14s;
}
.details-btn:active { background: var(--primary); color: #232a3c;}

/* ----- Bouton Panier flottant ----- */
.cart-float-btn {
  position: fixed; right: 16px; bottom: 18px; z-index: 120;
  background: var(--primary);
  color: #232a3c;
  border-radius: 20px;
  box-shadow: 0 4px 24px #0009, 0 2.5px 12px #FFD60022;
  padding: 0; width: 48px; height: 48px;
  display: flex; align-items: center; justify-content: center;
  font-size: 2.08rem; cursor: pointer;
  transition: background 0.18s, color 0.17s, transform 0.16s;
  border: none;
}
.cart-count-badge {
  background: var(--danger); color: white; font-size: 0.93rem;
  border-radius: 13px; padding: 0 7px; font-weight: 700;
  position: absolute; top: 5px; right: 6px; z-index: 10;
}

/* ----- Modale & détails produit ----- */
.modal-bg {
  position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
  background: #10141bde; z-index: 2000;
  display: flex; align-items: center; justify-content: center; transition: opacity 0.21s;
}
.modal-content {
  background: var(--card-bg); color: var(--text);
  border-radius: 13px;
  padding: 24px 8vw 16px 8vw;
  min-width: 0; max-width: 97vw;
  width: 96vw;
  box-shadow: 0 7px 36px #000c;
  position: relative; text-align: center;
}
.modal-content {
  max-height: 90vh;
  overflow-y: auto;
}
.modal-close {
  position: absolute; top: 12px; right: 16px; font-size: 1.5rem; color: var(--muted); cursor: pointer; background: none; border: none; z-index: 3;
}
.modal-title {
  font-size: 2.1rem;
  font-weight: 800;
  color: #ffd700;
  letter-spacing: 0.5px;
}

/* ----- Carte détails produit ----- */
.product-details-card {
  background: #23263a;
  border-radius: 18px;
  box-shadow: 0 2px 32px #0006;
  padding: 30px 22px 22px 22px;
  margin: 0 auto;
  max-width: 720px;
  color: #fff;
}
.details-header {
  text-align: center;
  margin-bottom: 15px;
}
.details-cat {
  font-size: 15px;
  font-weight: 600;
  color: #aaa;
  letter-spacing: 1.2px;
  margin-right: 10px;
  text-transform: uppercase;
}
.details-flex {
  display: flex;
  flex-wrap: wrap;
  gap: 22px;
  justify-content: center;
  align-items: flex-start;
}
.details-media {
  flex: 1 1 320px;
  min-width: 240px;
  max-width: 350px;
  display: flex;
  justify-content: center;
  align-items: center;
}
.details-info {
  flex: 2 1 360px;
  min-width: 220px;
  padding-top: 4px;
}
.details-desc {
  font-size: 1.05rem;
  font-weight: 500;
  margin-bottom: 12px;
  color: #fff;
}
.details-thc, .details-effet {
  margin-bottom: 9px;
  font-size: 1rem;
}
.details-thc span {
  color: #ffd700;
  font-weight: bold;
  font-size: 1.12rem;
  margin-left: 2px;
}
.details-prices {
  font-size: 1.08rem;
  font-weight: 600;
  margin-bottom: 14px;
  margin-top: 14px;
}

/* ----- Modale formulaire ----- */
.modal-field { display: flex; flex-direction: column; align-items: flex-start; margin: 13px 0 4px 0;}
.modal-field label { font-size: 0.98rem; font-weight: 500; margin-bottom: 3px; color: var(--muted);}
.modal-input, select.modal-input, textarea.modal-input {
  width: 100%; padding: 10px 11px; font-size: 1.07rem;
  border-radius: 7px; border: 1.5px solid #323e5a;
  background: #1b2130; color: var(--text); font-family: inherit; margin-bottom: 3px; resize: none;
}
.modal-btn { margin-top: 13px; background: var(--accent); color: var(--primary); font-weight: 700; border: none; border-radius: 9px; padding: 11px 10px; font-size: 1.09rem; cursor: pointer;}
.modal-btn:active { background: var(--primary); color: #181f2d;}
.modal-confirm { color: var(--green); margin-top: 11px;}
.modal-error { color: var(--danger); font-size: 0.96rem; margin-top: 5px;}

/* ----- Mobile Responsive (< 700px & < 500px) ----- */
@media (max-width: 700px) {
  .product-details-card { padding: 14px 2vw 8px; max-width: 99vw; }
  .details-header { font-size: 1.1rem; }
  .modal-title { font-size: 1.3rem; }
  
  .details-media {
    max-width: 97vw;
    margin: 0 auto 7px auto;
  }
  .details-media img,
  .details-media video {
    max-width: 97vw !important;
    width: 100% !important;
    min-width: 60vw;
  }
  .details-info {
    min-width: 0;
    padding: 2px 0 0 0;
  }
  .order-btn {
    font-size: 1.05rem;
    padding: 14px 0;
    width: 100%;
    margin: 22px 0 2px 0;
  }
}
@media (max-width: 500px) {
  .tg-header { padding: 11px 0 7px 0; }
  .tg-logo { width: 26px; height: 26px; margin-right: 7px;}
  .tg-title { font-size: 1.03rem; }
  .menu-top { padding: 0 2vw; }
  .products-grid { padding: 0 1vw; }
  .product-card { border-radius: 13px; }
  .card-img { border-radius: 13px 13px 0 0; height: 115px; }
  .modal-content { padding: 17px 2vw 10px 2vw; }
}
@media (max-width: 430px) {
  .modal-title { font-size: 1.02rem; }
  .order-btn { font-size: 0.96rem; padding: 11px 0; }
  .details-desc, .details-prices { font-size: 0.98rem; }
}

</style>
</head>
<body>
    <!-- Overlay Accès privé -->
    <div id="accessOverlay">
        <div class="access-box">
            <img src="https://files.catbox.moe/lkfhrl.jpeg" alt="Logo" style="width:85px; height:auto; border-radius:15px; margin-bottom:13px; box-shadow:0 4px 12px #0005; display:block; margin-left:auto; margin-right:auto;">
            <div class="access-title">Accès privé Side Industry 2.1</div>
            <div>Entrer le code d'accès pour voir le menu :</div>
            <input id="accessCode" class="access-input" type="password" maxlength="10" placeholder="Code secret">
            <br>
            <button class="access-btn" onclick="validateAccess()">Entrer</button>
            <div id="accessError" class="access-error"></div>
        </div>
    </div>
    <!-- HEADER -->
    <div class="tg-header">
        <img src="https://files.catbox.moe/lkfhrl.jpeg" alt="logo" class="tg-logo" />
        <span class="tg-title">Side Industry 2.1</span>
        <span class="tg-miniapp">mini-application</span>
    </div>
    <!-- TOP MENU -->
    <div class="menu-top">
      <button class="menu-btn" onclick="openInfo()">Info & Consignes</button>
    </div>
    <div class="welcome" id="welcomeMessage">
      <!-- Message de bienvenue chargé dynamiquement -->
    </div>
    <div class="section-title">CATÉGORIES</div>
    <div class="filters" id="filtersBar"></div>
    <div class="products-grid" id="productsGrid"></div>
    <!-- PANIER FLOAT BTN -->
    <button class="cart-float-btn" id="openCartBtn" onclick="openCart()">
        🛒
        <span class="cart-count-badge" id="cartCount" style="display:none">0</span>
    </button>
    <div id="modalBg" class="modal-bg" style="display:none">
        <div id="modalContent" class="modal-content"></div>
   </div>
<script>
// === VARIABLES GLOBALES ===
let siteConfig = {};
let menu = [];
let allowedCats = [];
let cart = [];

// === CHARGEMENT DES 2 FICHIERS JSON EN MÊME TEMPS ===
async function loadAllConfig() {
  const [menuRes, siteRes] = await Promise.all([
    fetch('/.netlify/functions/menu'),
    fetch('/.netlify/functions/site-config')
  ]);
  menu = await menuRes.json();
  siteConfig = await siteRes.json();

  // Affiche le message de bienvenue dynamiquement
  document.getElementById('welcomeMessage').innerHTML = siteConfig.welcome || "";

  updateAllowedCats();
  generateFilters();
  renderProducts();
}

// === ACCÈS AVEC CODE DYNAMIQUE (dans site_config.json) ===
function validateAccess() {
    const code = document.getElementById('accessCode').value.trim();
    if (code === siteConfig.access_code) {
        document.getElementById('accessOverlay').style.display = 'none';
        document.getElementById('accessError').innerText = "";
    } else {
        document.getElementById('accessError').innerText = "Code incorrect !";
    }
}

// === CATÉGORIES DU MENU ===
function updateAllowedCats() {
    allowedCats = [...new Set(menu.map(p => p.cat))].filter(Boolean);
}

// === GÉNÉRATION DES FILTRES ===
function generateFilters() {
    let html = `<button class="filter-btn active" onclick="filterProducts('all', this)">Tous les produits</button>`;
    allowedCats.forEach(cat => {
        html += `<button class="filter-btn" onclick="filterProducts('${cat.replace(/'/g,"\\'")}', this)">${cat}</button>`;
    });
    document.getElementById('filtersBar').innerHTML = html;
}

// === AFFICHAGE DES PRODUITS ===
function renderProducts(filterCat = 'all') {
    let productsHtml = "";
    let filteredMenu = menu.filter(prod => allowedCats.includes(prod.cat));
    if (filterCat && filterCat !== "all") {
        filteredMenu = filteredMenu.filter(prod => prod.cat === filterCat);
    }
    if(filteredMenu.length === 0) {
        productsHtml = `<div style="color:#FFD600;padding:22px 0;text-align:center;">Aucun produit dans cette catégorie.</div>`;
    } else {
        filteredMenu.forEach((prod, idx) => {
            productsHtml += `
                <div class="product-card" data-type="${prod.cat}">
                    <div class="product-type">${prod.cat}</div>
                    ${
  prod.img
    ? `<img class="card-img" src="${prod.img}" alt="photo ${prod.name}" loading="lazy" onerror="this.style.display='none'">`
    : prod.video
      ? `<video class="card-img" src="${prod.video}" muted autoplay loop playsinline preload="metadata" style="object-fit:cover;" onerror="this.replaceWith(document.createElement('div'))"></video>`
      : ""
}

                    <div style="padding:0 17px;">
                        <div class="product-name">${prod.name}</div>
                        <div class="product-price">${prod.desc || ""}</div>
                        ${prod.promo ? `<div class="product-promo">${prod.promo}</div>` : ""}
                        <button class="order-btn" onclick="chooseQuantity('${encodeURIComponent(JSON.stringify(prod))}')">Ajouter au panier</button>
                        <button class="details-btn" onclick="showDetails('${encodeURIComponent(JSON.stringify(prod))}')">Détails</button>
                    </div>
                </div>
            `;
        });
    }
    document.getElementById('productsGrid').innerHTML = productsHtml;
}

// === FILTRES PRODUITS UI ===
function filterProducts(cat, el) {
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
    if (el) el.classList.add('active');
    renderProducts(cat);
}

// === CHOIX QUANTITÉ ===
function chooseQuantity(prodStr) {
    let prod = JSON.parse(decodeURIComponent(prodStr));
    let qteHtml = `
        <div class="modal-title">Sélectionnez la quantité</div>
        <div style="margin-bottom:6px; color:var(--muted);"><b>${prod.name}</b></div>
        <form id="addCartForm" autocomplete="off" onsubmit="addToCart(event, '${encodeURIComponent(JSON.stringify(prod))}')">
            <div class="modal-field">
                <label for="qteSelect">Quantité :</label>
                <select class="modal-input" id="qteSelect" required onchange="toggleCustomQte(this)">
                    ${prod.prices ? prod.prices.map((p, i)=>`<option value="${i}">${p.qte} — ${p.price}€</option>`).join("") : ""}
                    <option value="custom">Personnalisé...</option>
                </select>
            </div>
            <div class="modal-field" id="customQteField" style="display:none;">
                <label>Prix personnalisé (€):</label>
                <input class="modal-input" type="number" id="customPrixInput" step="1" min="1" max="9999" placeholder="ex: 40, 50, 60">
            </div>
            <button class="modal-btn" type="submit">Ajouter au panier</button>
        </form>
    `;
    showModal(qteHtml);
}
window.toggleCustomQte = function(sel){
    let show = sel.value === "custom";
    document.getElementById('customQteField').style.display = show ? "block" : "none";
}

// === AJOUTER AU PANIER ===
function addToCart(e, prodStr) {
    e.preventDefault();
    let prod = JSON.parse(decodeURIComponent(prodStr));
    let select = document.getElementById('qteSelect');
    if (select.value === "custom") {
        let prix = parseInt(document.getElementById('customPrixInput').value, 10);
        if(!prix || isNaN(prix)) {
            alert("Indiquez un prix personnalisé.");
            return;
        }
        cart.push({name: prod.name, cat: prod.cat, price: prix, qte: `${prix}€`, count: 1});
    }
    else {
        let idx = parseInt(select.value, 10);
        let priceObj = prod.prices[idx];
        let found = cart.find(item=>item.name===prod.name && item.qte===priceObj.qte);
        if(found) found.count++;
        else cart.push({name: prod.name, cat: prod.cat, price: priceObj.price, qte: priceObj.qte, count: 1});
    }
    closeModal();
    updateCartBtn();
}

// === MAJ BOUTON PANIER ===
function updateCartBtn() {
    let n = cart.reduce((sum, item)=>sum+item.count, 0);
    let badge = document.getElementById('cartCount');
    badge.innerText = n;
    badge.style.display = n > 0 ? "inline-block" : "none";
}

// === OUVRIR PANIER POPUP ===
function openCart() {
    let n = cart.reduce((sum, item)=>sum+item.count, 0);
    let html = `<div class="modal-title">Votre panier</div>`;
    if(n === 0) {
        html += `<div style="color:var(--muted);margin-bottom:12px;">Votre panier est vide.</div>
            <button class="modal-btn" onclick="closeModal()">Fermer</button>`;
        showModal(html); return;
    }
    html += `<div style="text-align:left;">${cart.map((item, i)=>`
        <div style="margin-bottom:7px;">
            <b>${item.name}</b> (${item.qte}) x${item.count}
            <span style="color:var(--green);float:right;">${item.price*item.count}€</span><br>
            <a href="#" onclick="removeCart(${i});event.preventDefault();" style="font-size:0.97em;color:var(--danger);">Supprimer</a>
        </div>
    `).join("")}</div>`;
    html += `<div style="font-size:1.13em;margin-top:13px;"><b>Total :</b> <span style="color:var(--primary);font-weight:900;">${cart.reduce((s,i)=>s+i.price*i.count,0)}€</span></div>`;
    html += `<button class="modal-btn" onclick="checkout()">Finaliser la commande</button>
        <button class="details-btn" onclick="closeModal()" style="margin-top:8px;">Continuer mes achats</button>`;
    showModal(html);
}

// === SUPPRIMER UN PRODUIT DU PANIER ===
function removeCart(idx) {
    cart.splice(idx, 1);
    closeModal();
    updateCartBtn();
    openCart();
}

// === DÉTAILS PRODUIT ===
function showDetails(prodStr) {
  let prod = JSON.parse(decodeURIComponent(prodStr));
  let prixHtml = "";
  if (prod.prices && prod.prices.length) {
    prixHtml = prod.prices.map(p =>
      `${p.qte}: <b>${p.price}€</b>`
    ).join(' • ');
  }
  let details = `
  <button class="modal-close" onclick="closeModal()">&times;</button>
  <div class="product-details-card">
    <div class="details-header">
      <span class="details-cat">${prod.cat || ""}</span>
      <span class="modal-title">${prod.name || ""}</span>
    </div>
    <div class="details-flex">
      <div class="details-media">
        ${prod.video 
  ? `<video src="${prod.video}" controls preload="metadata" style="width:100%;max-width:340px;border-radius:18px;box-shadow:0 2px 18px #0003;margin-bottom:12px;background:#222;max-height:70vh;"></video>`
  : prod.img 
    ? `<img src="${prod.img}" style="width:100%;max-width:340px;border-radius:18px;box-shadow:0 2px 18px #0003;margin-bottom:12px;max-height:70vh;object-fit:cover;">`
    : ""
}

      </div>
      <div class="details-info">
        ${prod.desc ? `<div class="details-desc">${prod.desc}</div>` : ""}
        ${prod.effet ? `<div class="details-effet"><b>Effet :</b> ${prod.effet}</div>` : ""}
        ${prod.thclvl ? `<div class="details-thc"><b>THC :</b> <span>${prod.thclvl}%</span></div>` : ""}
        ${prod.prices && prod.prices.length ? `<div class="details-prices">
          <b>Tarifs :</b> ${prod.prices.map(p => `${p.qte}: <b>${p.price}€</b>`).join(' • ')}
        </div>` : ""}
      </div>
    </div>
    <button class="order-btn" onclick="chooseQuantity('${encodeURIComponent(JSON.stringify(prod))}')">
      Ajouter au panier
    </button>
  </div>
`;
showModal(details);
}

// === CHECKOUT ===
function checkout() {
    let html = `
        <button class="modal-close" onclick="closeModal()">&times;</button>
        <div class="modal-title">Finaliser la commande</div>
        <div style="margin-bottom:6px;text-align:left;">
            ${cart.map(item=>`
                <div><b>${item.name}</b> (${item.qte}) x${item.count} <span style="color:var(--green);float:right;">${item.price*item.count}€</span></div>
            `).join("")}
            <div style="font-size:1.09em;margin-top:7px;"><b>Total :</b> <span style="color:var(--primary);font-weight:900;">${cart.reduce((s,i)=>s+i.price*i.count,0)}€</span></div>
        </div>
        <form id="finalForm" autocomplete="off" onsubmit="sendOrder(event)">
            <div class="modal-field">
                <label for="delivery">Livraison :</label>
                <select class="modal-input" id="delivery" required>
                    <option value="Livraison à domicile">Livraison à domicile (min. 50€)</option>
                    <option value="Meet-Up">Meet-Up</option>
                </select>
            </div>
            <div class="modal-field">
                <label>Pseudo Telegram ( Mettre le @ avant le pseudo ex: @test)</label>
                <input class="modal-input" type="text" id="orderUser" required maxlength="24" autocomplete="off" placeholder="@">
            </div>
            <div class="modal-field">
                <label>Numéro de téléphone</label>
                <input class="modal-input" type="tel" id="orderPhone" required maxlength="18" autocomplete="off" placeholder="ex: 0612345678">
            </div>
            <div class="modal-field">
                <label>Adresse complète</label>
                <textarea class="modal-input" id="orderAddress" required maxlength="128" rows="2" placeholder="Adresse pour la livraison"></textarea>
            </div>
            <button class="modal-btn" type="submit">Confirmer la commande</button>
            <div id="finalError" class="modal-error"></div>
        </form>
    `;
    showModal(html);
}
// === ENVOI DE COMMANDE PAR TELEGRAM (via Netlify Function) ===
async function sendOrder(e) {
  e.preventDefault();
  let tgUser = document.getElementById('orderUser').value.trim();
  let delivery = document.getElementById('delivery').value;
  let phone = document.getElementById('orderPhone').value.trim();
  let address = document.getElementById('orderAddress').value.trim();

  if (!tgUser.startsWith('@') || tgUser.length < 4) {
    document.getElementById('finalError').innerText = "Entrez un pseudo Telegram valide.";
    return;
  }

  let total = cart.reduce((s,i)=>s+i.price*i.count,0);
  let details = cart.map(item => `${item.name} (${item.qte}) x${item.count}: ${item.price*item.count}€`).join('\n');
  let message =
`Nouvelle commande Side Industry 2.1 :
${details}
Total : ${total}€
Livraison ou meet up : ${delivery}
Pseudo Telegram : ${tgUser}
Numéro : ${phone}
Adresse : ${address}`;

  try {
    const r = await fetch('/.netlify/functions/send-order', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text: message })
    });

    if (!r.ok) throw new Error('send-order failed');

    showModal(`
      <div class="modal-title">Commande envoyée !</div>
      <div class="modal-confirm">
        Merci pour votre commande, elle est en cours de traitement.<br>
        <span style="font-size:1.6em;">✔️</span><br>
        <button class="modal-btn" onclick="closeModal();cart=[];updateCartBtn();renderProducts();">OK</button>
      </div>
    `);
    cart = [];
    updateCartBtn();
  } catch (err) {
    document.getElementById('finalError').innerText = "Erreur d'envoi. Essaie plus tard.";
  }
}

// === INFO & CONSIGNES DYNAMIQUE ===
function openInfo() {
    showModal(`
        <button class="modal-close" onclick="closeModal()">&times;</button>
        <div class="modal-title">Info & Consignes</div>
        <div style="text-align:left; margin-top:12px; font-size:1.04rem;">
            ${siteConfig.info}
        </div>
    `);
}

// === MODALS (générique) ===
function showModal(html) {
    document.getElementById('modalContent').innerHTML = html;
    document.getElementById('modalBg').style.display = 'flex';
}
function closeModal() {
    document.getElementById('modalBg').style.display = 'none';
}
document.getElementById('modalBg').addEventListener('click', function(e){
    if(e.target === this) closeModal();
});

// === LANCE TOUT ===
document.addEventListener('DOMContentLoaded', loadAllConfig);
</script>
</body>

</html>
